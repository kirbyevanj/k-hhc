name: CI

on:
  push:
    branches: [ master, staging, develop ]
  pull_request:
    branches: [ master, staging, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy clang
      - name: Configure CMake
        env:
          CC: clang
          CXX: clang++
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: Run clang-tidy
        run: |
          find k-hhc -name "*.cpp" -o -name "*.hpp" | \
          xargs -P$(nproc) clang-tidy -p build --warnings-as-errors=""

  cpp-build-test:
    name: C++ Build & Test (${{ matrix.os }} ${{ matrix.arch }})
    needs: lint
    runs-on: ${{ matrix.runs-on }}
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: x86_64
            runs-on: ubuntu-latest
          - os: windows
            arch: amd64
            runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup build env (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
      - name: Setup build env (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake ninja -y
      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
      - name: Configure CMake (Unix)
        if: runner.os != 'Windows'
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release
      - name: Build
        run: cmake --build build --parallel
      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure --parallel
      - name: Run examples
        working-directory: build
        shell: bash
        run: |
          echo "=== Running C++ examples ==="
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./examples/hhc_encode_example.exe
            ./examples/hhc_decode_example.exe
            ./examples/hhc_assert_example.exe
          else
            ./examples/hhc_encode_example
            ./examples/hhc_decode_example
            ./examples/hhc_assert_example
          fi
      - name: Upload C++ test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results-cpp-${{ matrix.os }}-${{ matrix.arch }}
          path: build/Testing/

  python-wheels:
    name: Python Wheels (${{ matrix.label }})
    needs: lint
    runs-on: ${{ matrix.runs-on }}
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: linux-x86_64
            os: linux
            runs-on: ubuntu-latest
            cibw_build: "cp311-manylinux_x86_64 cp311-musllinux_x86_64"
          - label: macos-universal2
            os: macos
            runs-on: macos-14
            cibw_build: "cp311-macosx_universal2"
          - label: windows-amd64
            os: windows
            runs-on: windows-latest
            cibw_build: "cp311-win_amd64"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Set up Python (build driver)
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          pip install build cibuildwheel==2.16.2
      - name: Build & Test wheels (cibuildwheel)
        env:
          CIBW_BUILD: ${{ matrix.cibw_build }}
          # Restrict to x86_64
          CIBW_ARCHS_LINUX: "x86_64"
          # Use modern manylinux
          CIBW_MANYLINUX_X86_64: "manylinux_2_28"
          # Install libexecinfo for musllinux (needed for execinfo.h/backtrace)
          CIBW_BEFORE_BUILD_MUSLLINUX: "apk update && apk add --no-cache libexecinfo-dev"
          CIBW_ENVIRONMENT_LINUX: "CC=gcc CXX=g++"
          # For musllinux: use -std=c++2a (GCC 9/10) instead of -std=c++20 (GCC 11+)
          # This works because c++2a is equivalent to C++20 for older GCC versions
          CIBW_ENVIRONMENT_MUSLLINUX: "CC=gcc CXX=g++ CXXFLAGS='-std=c++2a' LDFLAGS='-lexecinfo'"
          # Skip PyPy
          CIBW_SKIP: "pp*"
          CIBW_TEST_REQUIRES: "pytest"
          CIBW_TEST_COMMAND: >
            python -m pytest -q {project}/python/test_hhc.py &&
            python {project}/python/examples/encode_example.py &&
            python {project}/python/examples/decode_example.py &&
            python -c "import k_hhc, sys; print('Imported k_hhc OK on', sys.platform)"
          CIBW_BUILD_VERBOSITY: 1
        run: |
          python -m cibuildwheel --output-dir wheelhouse python
      - name: Build source distribution (single Linux x86_64)
        if: matrix.label == 'linux-x86_64'
        run: |
          cd python
          python -m build --sdist
      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: wheels-${{ matrix.label }}
          path: wheelhouse/*.whl
      - name: Upload sdist
        if: matrix.label == 'linux-x86_64'
        uses: actions/upload-artifact@v5
        with:
          name: sdist
          path: python/dist/*.tar.gz

  mac-x86-smoke:
    name: macOS x86_64 Smoke Test (Intel host)
    needs: python-wheels
    runs-on: macos-13
    timeout-minutes: 15
    steps:
      - name: Checkout (for tests only)
        uses: actions/checkout@v6
      - name: Download universal2 wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheels-macos-universal2
          path: wheels
      - name: List wheels
        run: ls -la wheels
      - name: Set up Python (3.12 Intel)
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install & smoke test
        run: |
          WHEEL=$(ls wheels/*universal2*.whl | head -1 || true)
          if [ -z "$WHEEL" ]; then
            echo "::error::No universal2 wheel found for macOS smoke test"
            ls -la wheels
            exit 1
          fi
          echo "Using wheel: $WHEEL"
          python -m pip install --upgrade pip
          python -m pip install pytest
          python -m pip install "$WHEEL"
          python -c "import k_hhc, platform; print('k_hhc version:', getattr(k_hhc,'__version__','?'),'arch:',platform.machine())"
          python python/examples/encode_example.py
          python python/examples/decode_example.py
          python -m pytest -q python/test_hhc.py
          echo "✓ macOS x86_64 smoke test passed"

  # ========== FINAL STATUS CHECK ==========
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, cpp-build-test, python-wheels, mac-x86-smoke]
    if: always()
    steps:
      - name: Check status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "::error::One or more required jobs failed"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "::warning::One or more jobs were cancelled"
          fi
          echo "✅ All required jobs passed!"